@page
@model SenseNet.IndexTools.Web.Pages.Operations.SubtreeCheckModel
@{
    ViewData["Title"] = "Subtree Check";
}

<div class="container">
    <div class="row mb-4">
        <div class="col">
            <h1>Subtree Check</h1>
            <p class="lead">Check if database content exists in the index for a specific subtree.</p>
        </div>
    </div>

    <div class="row mb-4">
        <div class="col">
            <div class="card">
                <div class="card-header">
                    <h5>Subtree Check Settings</h5>
                </div>
                <div class="card-body">
                    <form method="post">
                        <div class="mb-3">
                            <label for="indexPath" class="form-label">Index Path</label>
                            <select class="form-select" id="indexPath" name="indexPath" required>
                                <option value="">Select an index path...</option>
                                @foreach (var path in Model.IndexPaths)
                                {
                                    <option value="@path.Path">@path.Name (@path.Path)</option>
                                }
                            </select>
                            <div class="form-text">Or enter a custom path:</div>
                            <input type="text" class="form-control mt-2" id="customIndexPath" name="customIndexPath" placeholder="D:\path\to\index">
                        </div>

                        <div class="mb-3">
                            <label for="connectionString" class="form-label">Database Connection</label>
                            <select class="form-select" id="connectionString" name="connectionString" required>
                                <option value="">Select a database connection...</option>
                                @foreach (var conn in Model.DatabaseConnections)
                                {
                                    <option value="@conn.ConnectionString">@conn.Name</option>
                                }
                            </select>
                            <div class="form-text">Or enter a custom connection string:</div>
                            <input type="text" class="form-control mt-2" id="customConnectionString" name="customConnectionString" 
                                   placeholder="Data Source=server;Initial Catalog=sensenet;Integrated Security=True">
                        </div>

                        <div class="mb-3">
                            <label for="repositoryPath" class="form-label">Repository Path</label>
                            <input type="text" class="form-control" id="repositoryPath" name="repositoryPath" required 
                                   placeholder="/Root/Sites/Default_Site" value="/Root/Content">
                            <div class="form-text">Path in the content repository to check (e.g., /Root/Sites/Default_Site)</div>
                        </div>

                        <div class="mb-3 form-check">
                            <input type="checkbox" class="form-check-input" id="recursive" name="recursive" checked>
                            <label class="form-check-label" for="recursive">Check recursively</label>
                            <div class="form-text">Whether to check items recursively</div>
                        </div>

                        <div class="mb-3">
                            <label for="depth" class="form-label">Depth</label>
                            <input type="number" class="form-control" id="depth" name="depth" value="0" min="0">
                            <div class="form-text">Depth of recursion (0 = all descendants, 1 = direct children only)</div>
                        </div>

                        <div class="mb-3 form-check">
                            <input type="checkbox" class="form-check-input" id="detailed" name="detailed" checked>
                            <label class="form-check-label" for="detailed">Include detailed information</label>
                            <div class="form-text">Whether to include detailed information in the report</div>
                        </div>

                        <button type="submit" class="btn btn-primary">Check Subtree</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    @if (Model.ShowResult)
    {
        <div class="row">
            <div class="col">
                <div class="card">
                    <div class="card-header">
                        <h5>Check Result</h5>
                    </div>
                    <div class="card-body">
                        <div class="alert @Model.ResultClass" role="alert">
                            @Model.ResultMessage
                        </div>

                        @if (Model.SubtreeCheckResult != null)
                        {
                            <div class="mt-4">
                                <h6>Summary</h6>
                                <dl class="row">
                                    <dt class="col-sm-3">Repository Path</dt>
                                    <dd class="col-sm-9">@Model.SubtreeCheckResult.RepositoryPath</dd>

                                    <dt class="col-sm-3">Database Items</dt>
                                    <dd class="col-sm-9">@Model.SubtreeCheckResult.DatabaseItemsCount</dd>

                                    <dt class="col-sm-3">Index Documents</dt>
                                    <dd class="col-sm-9">@Model.SubtreeCheckResult.IndexDocCount</dd>

                                    <dt class="col-sm-3">Matched Items</dt>
                                    <dd class="col-sm-9">@Model.SubtreeCheckResult.MatchedItemsCount</dd>

                                    <dt class="col-sm-3">Mismatched Items</dt>
                                    <dd class="col-sm-9">@Model.SubtreeCheckResult.MismatchedItems.Count</dd>
                                </dl>

                                <div class="mt-3">
                                    <a asp-page="/Reports/ViewReport" asp-route-type="subtree" asp-route-id="@Model.ReportId" class="btn btn-primary">
                                        View Full Report
                                    </a>
                                </div>
                            </div>
                        }
                    </div>
                </div>
            </div>
        </div>
    }
</div>

@section Scripts {
    <script>
        // Custom index path
        document.getElementById('customIndexPath').addEventListener('input', function() {
            const dropdown = document.getElementById('indexPath');
            if (this.value) {
                dropdown.value = '';
                dropdown.disabled = true;
            } else {
                dropdown.disabled = false;
            }
        });

        // Custom connection string
        document.getElementById('customConnectionString').addEventListener('input', function() {
            const dropdown = document.getElementById('connectionString');
            if (this.value) {
                dropdown.value = '';
                dropdown.disabled = true;
            } else {
                dropdown.disabled = false;
            }
        });
    </script>
}
